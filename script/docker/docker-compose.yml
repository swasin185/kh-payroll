services:
    mariadb:
        image: mariadb:12-noble
        container_name: mariadb
        expose:
            - "3306"
        environment:
            MARIADB_ALLOW_EMPTY_ROOT_PASSWORD: "true"
            MARIADB_DATABASE: payroll
        volumes:
            - ../sql:/docker-entrypoint-initdb.d:ro
        healthcheck:
            test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
            interval: 5s
            timeout: 3s
            retries: 5
        networks:
            - payroll-net

    nuxt-app:
        build:
            context: ../..
            dockerfile: script/docker/Dockerfile
        image: kh-payroll:latest
        expose:
            - "3000"
        environment:
            DB_HOST: mariadb 
            NODE_ENV: production
        command: ["node", ".output/server/index.mjs"]
        depends_on:
            - mariadb
        networks:
            - payroll-net 

    nginx:
        image: nginx:latest
        ports:
            - "80:80"
            - "3443:3443"
        volumes:
            - ./nginx.conf:/etc/nginx/nginx.conf:ro
            - ../cert:/etc/nginx/certs:ro
        depends_on:
            - nuxt-app
        networks:
            - payroll-net 

networks:
    payroll-net:
        driver: bridge
